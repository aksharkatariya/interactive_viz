<!DOCTYPE html>
<html lang="en">
<style>
        body {
            font-family: Georgia, serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5dc; /* Light beige background */
        }
        #state-select-container {
            margin-bottom: 20px;
        }
        #state-select {
            margin-top: 10px;
            padding: 5px;
        }
        .container {
            display: flex;
            flex-wrap: wrap;
        }
        .first-content {
            display: flex;
            width: 100%;
            height: 50%;
            margin-bottom: 20px;
        }
        #d3-container {
            width: 50%;
            padding: 10px;
            box-sizing: border-box;
        }
        #d3-container_text {
            width: 18%;
            padding: 10px;
            box-sizing: border-box;
        }
        #d3-container_compare {
            width: 32%;
            padding: 10px;
            box-sizing: border-box;
        }
        #d3-container2 {
            width: 100%;
            height: 400px;
            border: 2px dotted #000;
            padding: 10px;
            box-sizing: border-box;
        }
        .second-content {
            display: flex;
            flex-wrap: nowrap;
            gap: 20px; /* Optional: Adds space between the two divs */
        }

        #d3-container2, #d3-container_map {
            width: 50%;
            height: 400px;
            border: 2px dotted #000;
            padding: 10px;
            box-sizing: border-box;
        }

        .container-header {
            font-size: 20px; /* Increased font size */
            font-weight: bold; /* Made the header bold */
        }

        #header {
            font-size: 24px; /* Larger font size for the main header */
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>
<head>
    <meta charset="UTF-8">
    <title>State Energy Sources</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="/path/to/textwrap.js"></script>
</head>
<body>

<div id="header">Which state are you from?</div>
    <select id="state-select">
        <option value="">Select a State</option>
    </select>
    <div class="first-content">
        <div id="d3-container">
            <div class="container-header">Energy Mix</div>
        </div>
        <div id="d3-container_text">
            <div class="container-header">Energy %</div>
        </div>
        <div id="d3-container_compare">
            <div class="container-header">Comparison to National Average</div>
        </div>
    </div>

  <div class="second-content">
    <div id="d3-container2">
        <div class="container-header">Clean Energy Goal</div>
    </div>
    <div id="d3-container_map">
        <div class="container-header">Clean Energy Map</div>
    </div>
  </div>


     <script>

         const national_average = [
             {"coal": 16.2, "natural gas": 43.1, "nuclear": 22.0, "petroleum": 0.4, "wind":
             10.2, "solar": 3.9, "hydro": 5.7, "biomass": 1.1, "geothermal": 0.4}];

        const states = [
  {
    "state": "Alabama (United States)",
    "nuclear": 32.2,
    "coal": 18.8,
    "natural gas": 37.6,
    "petroleum": 0,
    "hydro": 8.8,
    "geothermal": 0,
    "solar": 0.3,
    "wind": 0,
    "biomass": 2.2,
    "goal": "NA",
    "comment": "NA"
  },
  {
    "state": "Alaska (United States)",
    "nuclear": 0,
    "coal": 13.7,
    "natural gas": 41,
    "petroleum": 14.9,
    "hydro": 27.7,
    "geothermal": 0,
    "solar": 0,
    "wind": 2.1,
    "biomass": 0.6,
    "goal": "NA",
    "comment": "NA"
  },
  {
    "state": "Arizona (United States)",
    "nuclear": 29.1,
    "coal": 13.2,
    "natural gas": 44.4,
    "petroleum": 0,
    "hydro": 5.4,
    "geothermal": 0,
    "solar": 6.2,
    "wind": 1.5,
    "biomass": 0.2,
    "goal": "NA",
    "comment": "NA"
  },
  {
    "state": "Arkansas (United States)",
    "nuclear": 22.5,
    "coal": 35.6,
    "natural gas": 32.1,
    "petroleum": 0.1,
    "hydro": 7.3,
    "geothermal": 0,
    "solar": 0.8,
    "wind": 0,
    "biomass": 1.7,
    "goal": "NA",
    "comment": "NA"
  },
  {
    "state": "California (United States)",
    "nuclear": 8.4,
    "coal": 0.1,
    "natural gas": 49,
    "petroleum": 0,
    "hydro": 7.2,
    "geothermal": 5.8,
    "solar": 17.4,
    "wind": 7.9,
    "biomass": 4,
    "goal": "100% carbon-free electricity by 2045",
    "comment": "2018 legislation (SB 100) extended and expanded the existing state RPS. State agencies are required to submit implementation plans by January 1, 2021. Also in 2018, Gov. Jerry Brown�sExecutive Order B-55-18set a goal of statewide carbon neutrality by no later than 2045, with net negative GHG emissions thereafter."
  },
  {
    "state": "Colorado (United States)",
    "nuclear": 0,
    "coal": 41.6,
    "natural gas": 25.5,
    "petroleum": 0,
    "hydro": 2.8,
    "geothermal": 0,
    "solar": 3.1,
    "wind": 26.5,
    "biomass": 0.4,
    "goal": "100% carbon-free electricity by 2050 for Xcel Energy",
    "comment": "A 2019 law (SB 19-236) codified a pledge previously made by Xcel, whose service territory covers approximately 60% of the state�s load. It is mandatory “so long as it is technically and economically feasible.”"
  },
  {
    "state": "Connecticut (United States)",
    "nuclear": 39,
    "coal": 0.6,
    "natural gas": 55.6,
    "petroleum": 0.2,
    "hydro": 0.7,
    "geothermal": 0,
    "solar": 0.7,
    "wind": 0,
    "biomass": 3.2,
    "goal": "100% carbon-free electricity by 2040",
    "comment": "Governor Ned Lamont�s 2019 Executive Order (Number 3) set a 2040 goal for carbon-free electricity and asked the Department of Energy and Environmental Protection to develop a decarbonization plan for the power sector, in line with previous legislation to cut economy-wide carbon emissions by 80% below 2001 levels by 2050. In May 2022, Senate Bill 10,An Act Concerning Climate Change Mitigation, placed the goal into law."
  }
]
         const stateSelect = d3.select("#state-select");
         const container = d3.select("#d3-container");
         const goal_container = d3.select("#d3-container2");
         const text_container = d3.select("#d3-container_text");
         const compare_container = d3.select("#d3-container_compare");
         const map_container = d3.select("#d3-container_map");

         // Populate dropdown
         stateSelect.selectAll("option.state")
             .data(states)
             .enter()
             .append("option")
             .attr("value", d => d.state)
             .attr("class", "state")
             .text(d => d.state);

         const totalWidth = 600;

                const colors = {
            nuclear: "#4169E1",
            coal: "#8B4513",
            natural_gas: "#3CB371",
            petroleum: "#FF4500",
            hydro: "#1E90FF",
            geothermal: "#DAA520",
            solar: "#FFD700",
            wind: "#87CEEB",
            biomass: "#228B22"
        };
         const svg_stackbar = container.append("svg")
             .attr("width", totalWidth)
             .attr("height", 300)
             .style("display", "none");

         const svg_text = text_container.append("svg")
             .attr("width", 300)
             .attr("height", 300);

         const svg_diff = compare_container.append("svg")
             .attr("width", 300)
             .attr("height", 300);



         const svg_goal_text = goal_container.append("svg")
             .attr("width", 1000)
             .attr("height", 1000);


function wrap(text, width) {
    text.each(function() {
        const textElement = d3.select(this);
        const words = textElement.text().split(/\s+/).reverse();
        let word,
            line = [],
            lineNumber = 0,
            lineHeight = 1.1, // ems
            y = textElement.attr("y"),
            dy = parseFloat(textElement.attr("dy")) || 0,
            tspan = textElement.text(null)
                .append("tspan")
                .attr("x", textElement.attr("x"))
                .attr("y", y)
                .attr("dy", `${dy}em`);
        while ((word = words.pop())) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > width) {
                line.pop();
                tspan.text(line.join(" "));
                line = [word];
                tspan = textElement.append("tspan")
                    .attr("x", textElement.attr("x"))
                    .attr("y", y)
                    .attr("dy", `${++lineNumber * lineHeight + dy}em`)
                    .text(word);
            }
        }
    });
}

         // Dropdown change for rect
         stateSelect.on("change", function () {
             // Clearing previous visualization
             svg_stackbar.selectAll("rect").remove();
             svg_text.selectAll("text").remove();
             svg_diff.selectAll("rect").remove();
             svg_goal_text.selectAll("text").remove();
             const selectedState = this.value;
             if (!selectedState) {
                   svg_stackbar.style("display", "none");
                  svg_text.style("display", "none");
                  svg_diff.style("display", "none");
                  svg_goal_text.style("display", "none");
                 return;
             }
             const state = states.find(s => s.state === selectedState);
            svg_stackbar.style("display", "block");
            svg_text.style("display", "block");
            svg_diff.style("display", "block");
            svg_goal_text.style("display", "block");

           svg_diff.append("line")
                .attr("x1", totalWidth/1.2)
                .attr("y1", 0)
                .attr("x2", totalWidth/1.2)
                .attr("y2", 300)
                .attr("stroke", "gray")
                .attr("stroke-dasharray", "5,5");

             let trialX = 0;
             let text_gap = 24;
            const energySources = Object.keys(state).filter(key =>
                    key !== 'state' && key !== 'goal' && key !== 'comment'
                );

            energySources.forEach(source => {

                     const rectWidth = (state[source] / 100) * totalWidth;
                    // console.log(rectWidth);
                     svg_stackbar.append("rect")
                         .attr("x", trialX)
                         .attr("y", 10)
                         .attr("width", rectWidth)
                         .attr("height", 244)
                         .attr("fill", colors[source])
                         .attr("opacity", 0.8);

                     svg_text.append("text")
                         .attr("x", 15)
                         .attr("y", text_gap)
                         .text(`- ${source}: ${state[source]}%`)
                         .style("fill", colors[source])
                         .style("font-size", "18px")
                         .style("font-family", "Arial");

                      const nationalAvgValue = national_average[0][source];
                const difference = state[source] - nationalAvgValue;
                const diffRectWidth = Math.abs(difference / 100) * totalWidth;

                     svg_diff.append("rect")
                        .attr("fill", colors[source])
                        .attr("width", Math.abs(difference)*6)
                        .attr("height", 20)
                        .attr("y", text_gap - 16)
                        .attr("x", 400 / 2 + Math.min(0, difference)*6)
                        .attr("opacity", 0.8);



                     trialX += rectWidth;
                     text_gap += 28;
                 });

    svg_goal_text.append("text")
        .attr("x", 10)
        .attr("y", 60)
        .text(`Goal: ${state.goal}`)
        .style("font-size", "18px")
        .style("font-family", "Arial")
        .style("fill", "black")
        .call(wrap, 400);

    svg_goal_text.append("text")
        .attr("x", 10)
        .attr("y", 110)
        .text(`Comment: ${state.comment}`)
        .style("font-size", "15px")
        .style("font-family", "Arial")
        .style("fill", "black")
        .call(wrap, 400);

});

/// MAP ///
const svg_map = map_container.append("svg")
     .attr("width", 1000)
     .attr("height", 1000);


var projection = d3.geoMercator()
    .scale(100)
    .translate([100, 140]);

d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/us_states_hexgrid.geojson.json", function (data) {
    console.log(data);
    svg_map.append("g")
        .selectAll("path")
        .data(data.features)
        .enter()
        .append("path")
        .attr("fill", d => {
            const stateData = states.find(s => s.state === d.properties.google_name);
            if (!stateData) return "#ccc";
            return stateData.goal === "NA" ? "green" : "brown";
        })
        .attr("d", d3.geoPath().projection(projection))
        .attr("stroke", "black")
        .attr("fill-opacity", 1) // Set opacity to 1 to ensure visibility initially
        .on("click", function (event, d) {
            d3.select(this).attr("fill-opacity", 1); // Toggle fill-opacity on click
        });
});

     </script>
</body>
</html>

<!-- https://d3-graph-gallery.com/graph/hexbinmap_geo_basic.html -->
